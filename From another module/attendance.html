<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Auth Guard - Must be first to protect page -->
  <script src="../login/login-api.js"></script>
  <script src="../login/auth-guard.js"></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Management</title>
  <!-- UI Style Guide: Primary stylesheet -->
  <link rel="stylesheet" href="../capital-exchange/styles.css" />
  <!-- Global shared styles -->
  <link rel="stylesheet" href="../styles.css" />
  <!-- Page-specific overrides -->
  <link rel="stylesheet" href="attendance.css" />
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading_overlay.active { display:flex !important; }
  </style>
</head>
<body>
  <!-- Floating loading overlay - matches employee directory -->
  <div id="loading_overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:#0d1b0e; padding:2rem 3rem; border-radius:8px; border:1px solid #275b48; text-align:center;">
      <div style="width:50px; height:50px; border:4px solid #275b48; border-top-color:#198754; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem;"></div>
      <div style="color:#fff; font-size:1rem;">Loading attendance directory...</div>
    </div>
  </div>
  <div class="main-wrapper">
    <main class="container">
      <h2>Attendance Management</h2>
      <div class="summary-bar metrics">
        <div class="summary-item">
          <h4>Present Today</h4>
          <div class="value" id="presentToday">--</div>
        </div>
        <div class="summary-item">
          <h4>Absent Today</h4>
          <div class="value" id="absentToday">--</div>
        </div>
        <div class="summary-item">
          <h4>Late Today</h4>
          <div class="value" id="lateToday">--</div>
        </div>
        <div class="summary-item">
          <h4>Working from Home</h4>
          <div class="value" id="workingFromHome">--</div>
        </div>
        <div class="summary-item">
          <h4>On Leave Today</h4>
          <div class="value" id="onLeaveToday">--</div>
        </div>
      </div>
      <!-- Attendance Card (matches Employee Directory design) -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
          <h3 style="margin:0;">Attendance Management</h3>
          <div style="display:flex; gap:0.5rem;">
            <button class="btn-primary" style="background:linear-gradient(135deg, #6c757d 0%, #495057 100%);" onclick="AuditLogModal.open('Human Resources', 'Attendance')" title="View Audit Log">üìã Audit Log</button>
            <button class="btn-primary" style="background:linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);" onclick="window.refreshAttendanceDirectory?.()" title="Refresh">üîÑ Refresh</button>
          </div>
        </div>
        <!-- Filters -->
        <div class="card" style="margin-bottom:0.75rem;">
          <div class="filters-grid filter-bar-grid">
            <label>Search by Name
              <input type="text" id="attendanceNameFilter" placeholder="Search employees..." oninput="window.applyAttendanceFilters?.()" />
            </label>
            <label>Department
              <select id="attendanceDepartmentFilter" onchange="window.applyAttendanceFilters?.()">
                <option value="">All Departments</option>
                <!-- Departments loaded dynamically from Airtable -->
              </select>
            </label>
            <label>Date Range
              <select id="attendanceDateFilter" onchange="window.applyAttendanceFilters?.()">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
              </select>
            </label>
            <label>Status
              <select id="attendanceStatusFilter" onchange="window.applyAttendanceFilters?.()">
                <option value="">All Statuses</option>
                <option value="Present">‚úÖ Present</option>
                <option value="Absent">‚ùå Absent</option>
                <option value="Half Day">üïê Half Day</option>
                <option value="Undertime">‚è±Ô∏è Undertime</option>
                <option value="On Leave">üìÖ On Leave</option>
                <option value="No Record">‚ö™ No Record</option>
              </select>
            </label>
            <label>Location
              <select id="attendanceLocationFilter" onchange="window.applyAttendanceFilters?.()">
                <option value="">All Locations</option>
                <option value="Onsite">Onsite</option>
                <option value="Remote">Remote</option>
                <option value="Hybrid">Hybrid</option>
              </select>
            </label>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.5rem;">
            <div id="attendanceFilterSummary" class="muted">No filters applied</div>
            <button class="actions-btn" style="background:#198754;" onclick="window.clearAttendanceFilters?.()">Clear All Filters</button>
          </div>
        </div>
        <!-- Table -->
        <div class="table-wrapper">
          <table id="attendance-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Position</th>
                <th>Job Level</th>
                <th>Contract Status</th>
                <th>Rate Type</th>
                <th>Today's Status</th>
                <th style="text-align:center;">Actions</th>
              </tr>
            </thead>
            <tbody id="attendanceEmployeeTableBody">
              <!-- Rows populated by JavaScript -->
            </tbody>
          </table>
        </div>
        <!-- Pagination Controls -->
        <div class="pagination-controls" style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; padding:0.75rem; background:rgba(25,135,84,0.05); border-radius:8px; border:1px solid #275b48;">
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <span style="color:#ccc;">Show</span>
            <select id="attendancePageSize" onchange="window.changeAttendancePageSize?.()" style="padding:0.25rem 0.5rem; border-radius:4px; background:#0d1b0e; color:#fff; border:1px solid #275b48;">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="30">30</option>
              <option value="40">40</option>
              <option value="50">50</option>
            </select>
            <span style="color:#ccc;">entries</span>
          </div>
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <button class="actions-btn" id="attendancePrevBtn" onclick="window.prevAttendancePage?.()">‚Üê Previous</button>
            <span id="attendancePageInfo" style="color:#ccc; padding:0 0.5rem;">Page 1 of 1</span>
            <button class="actions-btn" id="attendanceNextBtn" onclick="window.nextAttendancePage?.()">Next ‚Üí</button>
          </div>
          <div style="color:#ccc;" id="attendanceShowingInfo">Showing 1-10 of 0</div>
        </div>
      </div>
    </main>
      <!-- View Attendance Modal -->
      <div id="attendanceModal" class="modal">
        <div class="modal-content" role="dialog" aria-modal="true" style="max-width:98%; width:1700px; position:relative;">
          <span class="close" onclick="window.closeAttendanceModal?.()">&times;</span>
          
          <!-- Company Header (Print Only) -->
          <div id="attendancePrintHeader" style="display:none; text-align:center; margin-bottom:1rem; padding-bottom:0.75rem; border-bottom:2px solid #000;">
            <h2 style="margin:0; font-size:14pt; color:#000; font-weight:700;">MORPH SAGRADO VENTURES INC.</h2>
            <p style="margin:0.25rem 0 0; font-size:9pt; color:#555;">Attendance Record</p>
          </div>
          
          <div class="modal-header">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
              <div>
                <h3 id="modalEmployeeName" style="margin:0;">Employee Attendance</h3>
                <p id="modalEmployeeId" class="muted" style="margin:.25rem 0 0;">Employee ID:</p>
              </div>
            </div>
          </div>
          <div class="modal-body">
            <div class="filters-grid" style="margin-bottom:0.75rem;">
              <label style="color: rgb(205, 205, 205)">Filter by Month
                <select id="modalMonthFilter" onchange="window.applyModalMonthFilter?.()">
                  <option value="1">January</option>
                  <option value="2">February</option>
                  <option value="3">March</option>
                  <option value="4">April</option>
                  <option value="5">May</option>
                  <option value="6">June</option>
                  <option value="7">July</option>
                  <option value="8">August</option>
                  <option value="9">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </label>
              <label style="color: rgb(205, 205, 205)">Year
                <select id="modalYearFilter" onchange="window.applyModalMonthFilter?.()">
                  <option value="2024">2024</option>
                  <option value="2025" selected>2025</option>
                  <option value="2026">2026</option>
                </select>
              </label>
              <!-- <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
                <button class="actions-btn" onclick="window.exportMonthlyReport?.()">Export Report</button>
              </div> -->
            </div>

            <div id="monthlySummary" style="margin-bottom:0.75rem;"></div>

            <div style="display:flex; justify-content:flex-end; margin-bottom:0.5rem; gap:0.5rem;">
              <button class="btn-primary delete-btn" id="deleteSelectedAttendanceBtn" style="display:none;" onclick="window.showBulkDeleteAttendanceModal?.()">
                üóëÔ∏è Delete Selected (<span id="selectedAttendanceCount">0</span>)
              </button>
              <button class="btn-primary" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="window.showDiagnoseAttendanceModal?.()" title="Diagnose & Recalculate Rates">üîç Diagnose Rates</button>
              <button class="btn-primary" style="background:linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);" onclick="window.refreshAttendanceModal?.()" title="Refresh Attendance">üîÑ Refresh</button>
              <button class="btn-primary" style="background:#2563eb;" onclick="window.showBatchAddAttendanceModal?.()">üìÖ Batch Add Attendance</button>
              <button class="btn-primary" onclick="window.showAddAttendanceModal?.()">Add Attendance</button>
            </div>

            <div class="table-wrapper" style="overflow-x:auto;">
              <table style="width:100%">
                <thead>
                    <tr>
                      <th style="width:40px; text-align:center;">
                        <input type="checkbox" id="selectAllAttendance" onclick="window.toggleSelectAllAttendance?.()" title="Select All" style="cursor:pointer; width:18px; height:18px;" />
                      </th>
                      <th>Date</th>
                      <th>Time In</th>
                      <th>Time Out</th>
                      <th>Total Hours</th>
                      <th>Rate</th>
                      <th>Overtime</th>
                      <th>Overtime Pay</th>
                      <th>Double Pay</th>
                      <th>Leave Type</th>
                      <th>Status</th>
                      <th>Remarks</th>
                      <th style="text-align:center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="attendanceModalBody"></tbody>
              </table>
            </div>
            
            <!-- Signature Section (Print Only) -->
            <div id="attendanceSignatureSection" style="display:none; margin-top:30px; padding-top:20px; border-top:1px solid #333;">
              <div style="display:flex; justify-content:space-between; gap:60px;">
                <div style="flex:1; text-align:center;">
                  <div style="border-top:1px solid #000; padding-top:8px; margin-top:50px;">
                    <p style="margin:0; font-weight:600; color:#000;" id="printAttendanceEmployeeName">Employee Name</p>
                    <p style="margin:4px 0 0; font-size:9pt; color:#555;" id="printAttendanceEmployeeId">Employee ID</p>
                    <p style="margin:4px 0 0; font-size:9pt; color:#555;" id="printAttendanceEmployeeDept">Department</p>
                  </div>
                  <p style="margin-top:4px; font-size:8pt; color:#666;">RECEIVED BY</p>
                </div>
                <div style="flex:1; text-align:center;">
                  <div style="border-top:1px solid #000; padding-top:8px; margin-top:50px;">
                    <p style="margin:0; font-weight:600; color:#000;">MIGUELITO S. FAILDON</p>
                    <p style="margin:4px 0 0; font-size:9pt; color:#555;">Chairman of the Board and Chief Visionary Officer</p>
                  </div>
                  <p style="margin-top:4px; font-size:8pt; color:#666;">APPROVED BY</p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer no-print" style="margin-top: 10px; display:flex; justify-content:flex-end; gap:0.5rem;">
            <button class="actions-btn" onclick="window.printAttendanceRecords?.()" style="background:#0dcaf0; color:#0d1b0e;">üñ®Ô∏è Print</button>
            <button class="actions-btn" onclick="window.exportMonthlyReport?.()">Export Report</button>
            <button class="actions-btn" onclick="window.closeAttendanceModal?.()">Close</button>
          </div>
        </div>
      </div>

      <!-- Print Styles for Attendance Records -->
      <style id="attendancePrintStyles">
        @media print {
          /* Page setup */
          @page {
            size: A4 portrait;
            margin: 15mm 12mm 10mm 12mm;
          }
          
          /* Only apply these styles when printing attendance */
          body.printing-attendance {
            margin: 0 !important;
            padding: 0 !important;
            background: #fff !important;
          }
          
          body.printing-attendance * {
            visibility: hidden;
          }
          
          body.printing-attendance #attendanceModal,
          body.printing-attendance #attendanceModal * {
            visibility: visible !important;
          }
          
          body.printing-attendance #attendanceModal {
            position: absolute !important;
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            height: auto !important;
            background: #fff !important;
            overflow: visible !important;
            display: block !important;
            padding: 0 !important;
            margin: 0 !important;
            z-index: 99999 !important;
          }
          
          body.printing-attendance #attendanceModal .modal-content {
            max-width: 100% !important;
            width: 100% !important;
            max-height: none !important;
            overflow: visible !important;
            box-shadow: none !important;
            border: none !important;
            background: #fff !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
          }
          
          /* Show company header on print - compact */
          body.printing-attendance #attendancePrintHeader {
            display: block !important;
            border-bottom: 1px solid #000 !important;
            margin-bottom: 4px !important;
            padding-bottom: 4px !important;
          }
          
          body.printing-attendance #attendancePrintHeader h2 {
            color: #000 !important;
            font-size: 13pt !important;
            margin: 0 !important;
          }
          
          body.printing-attendance #attendancePrintHeader p {
            color: #333 !important;
            font-size: 9pt !important;
            margin: 2px 0 0 0 !important;
          }
          
          /* Hide close button, footer, filters, add buttons */
          body.printing-attendance #attendanceModal .close,
          body.printing-attendance #attendanceModal .no-print,
          body.printing-attendance #attendanceModal .filters-grid,
          body.printing-attendance #attendanceModal button,
          body.printing-attendance #attendanceModal .modal-footer {
            display: none !important;
          }
          
          /* Modal body - prevent page breaks between sections */
          body.printing-attendance #attendanceModal .modal-body {
            overflow: visible !important;
            padding: 0 !important;
          }
          
          /* Modal header - compact */
          body.printing-attendance #attendanceModal .modal-header {
            background: #fff !important;
            border-bottom: 1px solid #000 !important;
            padding: 4px 0 !important;
            margin-bottom: 6px !important;
          }
          
          body.printing-attendance #attendanceModal .modal-header h3,
          body.printing-attendance #modalEmployeeName {
            color: #000 !important;
            font-size: 12pt !important;
            margin: 0 !important;
          }
          
          body.printing-attendance #attendanceModal .modal-header p,
          body.printing-attendance #modalEmployeeId {
            color: #333 !important;
            font-size: 9pt !important;
            margin: 2px 0 0 !important;
          }
          
          /* Monthly summary - compact header style, no page break after */
          body.printing-attendance #monthlySummary {
            background: #f5f5f5 !important;
            border: 2px solid #333 !important;
            padding: 8px 10px !important;
            margin-bottom: 8px !important;
            border-radius: 0 !important;
            page-break-after: avoid !important;
          }
          
          body.printing-attendance #monthlySummary * {
            color: #000 !important;
            background: transparent !important;
          }
          
          body.printing-attendance #monthlySummary .card {
            margin-bottom: 0 !important;
            padding: 0 !important;
          }
          
          body.printing-attendance #monthlySummary h4 {
            font-size: 10pt !important;
            margin: 0 0 2px 0 !important;
          }
          
          body.printing-attendance #monthlySummary p.muted {
            font-size: 7pt !important;
            margin: 0 !important;
            line-height: 1.2 !important;
          }
          
          /* Rate info - compact inline */
          body.printing-attendance #monthlySummary div[style*="text-align:right"] {
            font-size: 8pt !important;
          }
          
          body.printing-attendance #monthlySummary div[style*="text-align:right"] .muted {
            font-size: 7pt !important;
            margin-top: 0 !important;
          }
          
          body.printing-attendance #monthlySummary div[style*="text-align:right"] div[style*="font-weight:600"] {
            font-size: 8pt !important;
          }
          
          /* Summary grid - very compact */
          body.printing-attendance #monthlySummary div[style*="grid-template-columns"] {
            gap: 3px !important;
            margin-top: 3px !important;
            padding-top: 3px !important;
          }
          
          body.printing-attendance #monthlySummary .summary-item {
            padding: 2px 4px !important;
            background: #e8e8e8 !important;
            border: 1px solid #999 !important;
          }
          
          body.printing-attendance #monthlySummary .summary-item .muted {
            font-size: 6pt !important;
          }
          
          body.printing-attendance #monthlySummary .summary-item .value {
            font-size: 8pt !important;
            font-weight: bold !important;
          }
          
          body.printing-attendance #monthlySummary div[style*="background"] {
            background: #e8e8e8 !important;
            border: 1px solid #999 !important;
            padding: 2px 4px !important;
          }
          
          /* Table styles - Compact for printing, no page breaks */
          body.printing-attendance #attendanceModal table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-size: 8pt !important;
            margin-top: 8px !important;
            page-break-before: avoid !important;
            page-break-inside: auto !important;
            border: 2px solid #333 !important;
          }
          
          body.printing-attendance #attendanceModal tbody tr {
            page-break-inside: avoid !important;
          }
          
          body.printing-attendance #attendanceModal tbody tr:last-child td {
            border-bottom: 2px solid #333 !important;
          }
          
          body.printing-attendance #attendanceModal thead {
            background: #e8e8e8 !important;
          }
          
          body.printing-attendance #attendanceModal th {
            background: #e0e0e0 !important;
            color: #000 !important;
            font-weight: bold !important;
            border: 1px solid #333 !important;
            padding: 2px 3px !important;
            font-size: 8pt !important;
            text-align: center !important;
          }
          
          body.printing-attendance #attendanceModal td {
            background: #fff !important;
            color: #000 !important;
            border: 1px solid #333 !important;
            padding: 2px 3px !important;
            font-size: 8pt !important;
          }
          
          body.printing-attendance #attendanceModal tbody tr:nth-child(even) td {
            background: #f9f9f9 !important;
          }
          
          /* Hide actions column */
          body.printing-attendance #attendanceModal th:last-child,
          body.printing-attendance #attendanceModal td:last-child {
            display: none !important;
          }
          
          /* Status text colors */
          body.printing-attendance #attendanceModal span[style*="color:#16a34a"],
          body.printing-attendance #attendanceModal span[style*="color:#28a745"] {
            color: #006600 !important;
          }
          
          body.printing-attendance #attendanceModal span[style*="color:#dc3545"],
          body.printing-attendance #attendanceModal span[style*="color:#dc2626"] {
            color: #990000 !important;
          }
          
          body.printing-attendance #attendanceModal span[style*="color:#ca8a04"] {
            color: #996600 !important;
          }
          
          body.printing-attendance #attendanceModal span[style*="color:#2563eb"] {
            color: #000099 !important;
          }
          
          body.printing-attendance #attendanceModal span[style*="color:#ea580c"] {
            color: #cc4400 !important;
          }
          
          /* Signature Section - Hide in print */
          body.printing-attendance #attendanceSignatureSection {
            display: none !important;
          }
          
          /* Hide other modals during attendance print */
          body.printing-attendance #editAttendanceModal,
          body.printing-attendance #addAttendanceModal,
          body.printing-attendance #deleteAttendanceModal,
          body.printing-attendance .modal:not(#attendanceModal) {
            display: none !important;
            visibility: hidden !important;
          }
        }
      </style>

      <!-- Edit Attendance Modal -->
        <div id="editAttendanceModal" class="modal">
          <div class="modal-content" role="dialog" aria-modal="true">
            <span class="close" onclick="window.closeEditAttendanceModal?.()">&times;</span>
            <div class="modal-header">
              <h3 style="margin:0;">Edit Attendance Record</h3>
            </div>
            <form id="editAttendanceForm">
              <div class="modal-body">
                <input type="hidden" id="editAttendanceId" name="id" />
                <input type="hidden" id="editEmployeeId" name="employeeId" />
                <!-- Lunch Adjustment Badge -->
                <div id="editLunchAdjustmentBadge" style="display:none; margin-bottom:.75rem; padding:.5rem .75rem; background:linear-gradient(135deg, #ca8a04 0%, #a16207 100%); border-radius:8px; border:1px solid #eab308;">
                  <div style="display:flex; align-items:center; gap:.5rem;">
                    <span style="font-size:1.1rem;">üçΩÔ∏è</span>
                    <div>
                      <div style="color:#fff; font-weight:600; font-size:.85rem;">1-Hour Lunch Break Included</div>
                      <div style="color:rgba(255,255,255,0.8); font-size:.75rem;">Schedule: <span id="editScheduleDisplay">10 hrs</span> | Actual Work: <span id="editActualWorkDisplay">9 hrs</span></div>
                    </div>
                  </div>
                </div>
                <div class="filters-grid">
                    <div style="display:flex; align-items:center; justify-content:left; text-align:center; height:100%; min-height:70px; color:#fff; font-size:1.2rem; font-weight:500;">
                  <span id="editEmployeeName"></span>
                  <span id="editEmployeeDisplayId" style="margin-left:.5rem; opacity:.85;"></span>
                </div>
                  <label>Date *
                    <input type="date" id="editDate" name="date" required />
                  </label>
                  <label>Time In (AM)
                    <input type="time" id="editTimeInAM" name="timeInAM" />
                  </label>
                  <label>Time Out (AM)
                    <input type="time" id="editTimeOutAM" name="timeOutAM" />
                  </label>
                  <label>Time In (PM)
                    <input type="time" id="editTimeInPM" name="timeInPM" />
                  </label>
                  <label>Time Out (PM)
                    <input type="time" id="editTimeOutPM" name="timeOutPM" />
                  </label>
                  <label>Remarks
                    <textarea id="editRemarks" name="remarks" rows="2"></textarea>
                  </label>
                  <label>Leave Type
                    <select id="editLeaveType" name="leaveType" style="width:100%; padding:0.5rem; border:1px solid #444; border-radius:4px; background:#2a2a2a; color:#fff;">
                      <option value="None">None</option>
                      <option value="Personal">Personal</option>
                      <option value="Sick">Sick</option>
                      <option value="Vacation">Vacation</option>
                    </select>
                  </label>
                </div>
                <div class="form-check" style="margin-top:.5rem;">
                  <input type="checkbox" id="editIsDoublePay" name="isDoublePay" />
                  <label for="editIsDoublePay" style="margin:0;">Double Pay (Sunday/Holiday)</label>
                </div>
                <div class="card" style="margin-top:.75rem;">
                  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:.5rem;">
                    <div class="summary-item">
                      <div class="muted">Total Hours</div>
                      <div class="value" id="editTotalHours">-</div>
                    </div>
                    <div class="summary-item">
                      <div class="muted">Overtime Hours</div>
                      <div class="value" id="editOvertimeHours">-</div>
                    </div>
                    <div class="summary-item">
                      <div class="muted">Overtime Pay</div>
                      <div class="value" id="editOvertimePay">-</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem;">
                <button type="button" class="actions-btn" onclick="window.closeEditAttendanceModal?.()">Cancel</button>
                <button type="submit" class="actions-btn">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

      <!-- Add Attendance Modal -->
      <div id="addAttendanceModal" class="modal">
        <div class="modal-content" role="dialog" aria-modal="true">
          <span class="close" onclick="window.closeAddAttendanceModal?.()">&times;</span>
          <div class="modal-header">
            <h3 style="margin:0;">Add Attendance Record</h3>
          </div>
          <form id="addAttendanceForm">
            <div class="modal-body">
              <input type="hidden" id="addEmployeeId" name="employeeId" />
              <!-- Lunch Adjustment Badge -->
              <div id="addLunchAdjustmentBadge" style="display:none; margin-bottom:.75rem; padding:.5rem .75rem; background:linear-gradient(135deg, #ca8a04 0%, #a16207 100%); border-radius:8px; border:1px solid #eab308;">
                <div style="display:flex; align-items:center; gap:.5rem;">
                  <span style="font-size:1.1rem;">üçΩÔ∏è</span>
                  <div>
                    <div style="color:#fff; font-weight:600; font-size:.85rem;">1-Hour Lunch Break Included</div>
                    <div style="color:rgba(255,255,255,0.8); font-size:.75rem;">Schedule: <span id="addScheduleDisplay">10 hrs</span> | Actual Work: <span id="addActualWorkDisplay">9 hrs</span></div>
                  </div>
                </div>
              </div>
              <div class="filters-grid">
                <div style="display:flex; align-items:center; justify-content:left; text-align:center; height:100%; min-height:70px; color:#fff; font-size:1.2rem; font-weight:500;">
                  <span id="addEmployeeName"></span>
                  <span id="addEmployeeDisplayId" style="margin-left:.5rem; opacity:.85;"></span>
                </div>
                <label>Date *
                  <input type="date" id="addDate" name="date" required />
                </label>
                <label>Time In (AM)
                  <input type="time" id="addTimeInAM" name="timeInAM" />
                </label>
                <label>Time Out (AM)
                  <input type="time" id="addTimeOutAM" name="timeOutAM" />
                </label>
                <label>Time In (PM)
                  <input type="time" id="addTimeInPM" name="timeInPM" />
                </label>
                <label>Time Out (PM)
                  <input type="time" id="addTimeOutPM" name="timeOutPM" />
                </label>
                <label>Remarks
                  <textarea id="addRemarks" name="remarks" rows="2"></textarea>
                </label>
                  <label>Leave Type
                    <select id="addLeaveType" name="leaveType" style="width:100%; padding:0.5rem; border:1px solid #444; border-radius:4px; background:#2a2a2a; color:#fff;">
                      <option value="None">None</option>
                      <option value="Personal">Personal</option>
                      <option value="Sick">Sick</option>
                      <option value="Vacation">Vacation</option>
                    </select>
                  </label>
                </div>
                <div class="form-check" style="margin-top:.5rem;">
                  <input type="checkbox" id="addIsDoublePay" name="isDoublePay" />
                  <label for="addIsDoublePay" style="margin:0;">Double Pay (Sunday/Holiday)</label>
                </div>
              <div class="card" style="margin-top:.75rem;">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:.5rem;">
                  <div class="summary-item">
                    <div class="muted">Total Hours</div>
                    <div class="value" id="addTotalHours">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="muted">Overtime Hours</div>
                    <div class="value" id="addOvertimeHours">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="muted">Overtime Pay</div>
                    <div class="value" id="addOvertimePay">-</div>
                  </div>
                </div>
              </div>
            </div>
             <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem;">
              <button type="button" class="actions-btn" onclick="window.closeAddAttendanceModal?.()">Cancel</button>
              <button type="submit" class="actions-btn">Add Attendance</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Batch Add Attendance Modal -->
      <div id="batchAddAttendanceModal" class="modal">
        <div class="modal-content" role="dialog" aria-modal="true" style="max-width:700px;">
          <span class="close" onclick="window.closeBatchAddAttendanceModal?.()">&times;</span>
          <div class="modal-header">
            <h3 style="margin:0;">üìÖ Batch Add Attendance Records</h3>
          </div>
          <form id="batchAddAttendanceForm">
            <div class="modal-body">
              <input type="hidden" id="batchEmployeeId" name="employeeId" />
              
              <!-- Employee Info -->
              <div style="display:flex; align-items:center; justify-content:center; text-align:center; padding:0.75rem; background:rgba(255,255,255,0.05); border-radius:6px; margin-bottom:1rem;">
                <span id="batchEmployeeName" style="color:#fff; font-size:1.1rem; font-weight:500;"></span>
                <span id="batchEmployeeDisplayId" style="margin-left:.5rem; opacity:.85; color:#ccc;"></span>
              </div>
              
              <!-- Date Range -->
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:1rem;">
                <label style="color:#fff;">Start Date *
                  <input type="date" id="batchStartDate" name="startDate" required />
                </label>
                <label style="color:#fff;">End Date *
                  <input type="date" id="batchEndDate" name="endDate" required />
                </label>
              </div>
              
              <!-- Day Selection -->
              <div style="margin-bottom:1rem;">
                <label style="display:block; margin-bottom:0.5rem; color:#fff;">Days to Include:</label>
                <div style="display:flex; flex-wrap:wrap; gap:0.75rem;">
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchMon" checked /> <span>Mon</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchTue" checked /> <span>Tue</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchWed" checked /> <span>Wed</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchThu" checked /> <span>Thu</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchFri" checked /> <span>Fri</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchSat" /> <span>Sat</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                    <input type="checkbox" id="batchSun" /> <span>Sun</span>
                  </label>
                </div>
              </div>
              
              <!-- Default Time Schedule -->
              <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:1rem; margin-bottom:1rem;">
                <label style="color:#fff;">Time In (AM)
                  <input type="time" id="batchTimeInAM" name="timeInAM" value="08:00" />
                </label>
                <label style="color:#fff;">Time Out (AM)
                  <input type="time" id="batchTimeOutAM" name="timeOutAM" value="12:00" />
                </label>
                <label style="color:#fff;">Time In (PM)
                  <input type="time" id="batchTimeInPM" name="timeInPM" value="13:00" />
                </label>
                <label style="color:#fff;">Time Out (PM)
                  <input type="time" id="batchTimeOutPM" name="timeOutPM" value="17:00" />
                </label>
              </div>
              
              <!-- Options -->
              <div style="display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;">
                <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                  <input type="checkbox" id="batchSkipExisting" checked /> 
                  <span>Skip existing records (avoid duplicates)</span>
                </label>
                <label style="display:flex; align-items:center; gap:0.25rem; cursor:pointer; color:#fff;">
                  <input type="checkbox" id="batchDoublePaySunday" /> 
                  <span>Double Pay for Sundays</span>
                </label>
              </div>
              
              <!-- Preview Section -->
              <div id="batchPreviewSection" style="display:none; margin-top:1.25rem; background:rgba(0,0,0,0.25); border:1px solid rgba(102, 255, 178, 0.2); border-radius:8px; padding:1rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem; padding-bottom:0.75rem; border-bottom:1px solid rgba(102, 255, 178, 0.15);">
                  <h4 style="margin:0; color:#66ffb2; font-size:0.95rem; display:flex; align-items:center; gap:0.5rem;">
                    <span style="font-size:1.1rem;">üìã</span> Preview
                  </h4>
                  <div style="display:flex; align-items:center; gap:0.75rem;">
                    <span id="batchPreviewCount" style="background:rgba(25,135,84,0.3); color:#66ffb2; padding:0.3rem 0.75rem; border-radius:15px; font-size:0.8rem; font-weight:600;"></span>
                    <button type="button" style="padding:0.35rem 0.75rem; font-size:0.8rem; background:rgba(108,117,125,0.3); border:1px solid rgba(108,117,125,0.5); color:#ccc; border-radius:5px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='rgba(108,117,125,0.5)'" onmouseout="this.style.background='rgba(108,117,125,0.3)'" onclick="window.closeBatchPreview?.()">‚úï Close Preview</button>
                  </div>
                </div>
                <div id="batchPreviewList" style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:6px; padding:0.5rem;">
                  <!-- Preview items will be inserted here -->
                </div>
                <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid rgba(102, 255, 178, 0.1); display:flex; align-items:center; gap:0.5rem;">
                  <span style="color:#8ab8a8; font-size:0.8rem;">üí° Tip: Uncheck dates you want to exclude from batch add.</span>
                </div>
              </div>
              
              <!-- Progress Section -->
              <div id="batchProgressSection" style="display:none; margin-top:1.25rem; background:rgba(0,0,0,0.25); border:1px solid rgba(25,135,84,0.4); border-radius:8px; padding:1.25rem;">
                <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
                  <div style="width:40px; height:40px; border:3px solid rgba(25,135,84,0.3); border-top-color:#198754; border-radius:50%; animation:spin 1s linear infinite;"></div>
                  <div style="flex:1;">
                    <div id="batchProgressText" style="color:#66ffb2; font-size:1rem; font-weight:600; margin-bottom:0.25rem;">Adding records...</div>
                    <div style="color:#8ab8a8; font-size:0.85rem;">Please wait while records are being added</div>
                  </div>
                  <div id="batchProgressCount" style="background:rgba(25,135,84,0.3); color:#66ffb2; padding:0.4rem 0.85rem; border-radius:15px; font-size:0.85rem; font-weight:600;">0 / 0</div>
                </div>
                <div style="background:rgba(0,0,0,0.3); border-radius:8px; height:12px; overflow:hidden; border:1px solid rgba(102,255,178,0.15);">
                  <div id="batchProgressBar" style="background:linear-gradient(90deg, #198754, #20c997); height:100%; width:0%; transition:width 0.3s ease; border-radius:8px;"></div>
                </div>
                <div id="batchProgressDetails" style="margin-top:0.75rem; display:flex; justify-content:space-between; font-size:0.8rem; color:#8ab8a8;">
                  <span>‚è±Ô∏è Processing...</span>
                  <span id="batchProgressPercent">0%</span>
                </div>
              </div>
            </div>
            <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1.5rem; padding-top:1rem; border-top:1px solid rgba(102,255,178,0.15);">
              <button type="button" class="actions-btn" id="batchCancelBtn" onclick="window.cancelBatchAddAttendance?.()">Cancel</button>
              <button type="button" class="actions-btn" style="background:#2563eb;" id="batchPreviewBtn" onclick="window.generateBatchPreview?.()">Preview</button>
              <button type="submit" class="actions-btn" id="batchSubmitBtn">Add All Records</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="deleteAttendanceModal" class="modal" style="z-index:100000;">
        <div class="modal-content" role="dialog" aria-modal="true" style="z-index:100001;">
          <span class="close" onclick="window.closeDeleteAttendanceModal?.()">&times;</span>
          <div class="modal-header">
            <h3 style="margin:0;">Confirm Delete</h3>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete the attendance record for <span id="deleteDate" class="font-semibold"></span>?</p>
            <p class="muted" style="margin-top:.5rem;">This action cannot be undone.</p>
          </div>
          <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem;">
            <button class="actions-btn" onclick="window.closeDeleteAttendanceModal?.()">Cancel</button>
            <button class="actions-btn delete-btn" onclick="window.deleteAttendance?.()">Delete Record</button>
          </div>
        </div>
      </div>

      <!-- Bulk Delete Attendance Modal -->
      <div id="bulkDeleteAttendanceModal" class="modal" style="z-index:100000;">
        <div class="modal-content" role="dialog" aria-modal="true" style="z-index:100001;">
          <span class="close" id="bulkDeleteCloseBtn" onclick="window.hideBulkDeleteAttendanceModal?.()">&times;</span>
          <div class="modal-header">
            <h3 style="margin:0;">üóëÔ∏è Delete Multiple Attendance Records</h3>
          </div>
          <div class="modal-body">
            <!-- Confirmation Section -->
            <div id="bulkDeleteConfirmSection">
              <p>Are you sure you want to delete <strong id="bulkAttendanceDeleteCount">0</strong> selected attendance records?</p>
              <div id="bulkAttendanceDeleteList" style="max-height:200px; overflow-y:auto; background:#0a1510; border:1px solid #275b48; border-radius:8px; padding:0.75rem; margin:1rem 0;">
                <!-- Selected records will be listed here -->
              </div>
              <p style="color:#c53045; font-weight:600;">‚ö†Ô∏è This action cannot be undone.</p>
            </div>
            <!-- Progress Section (hidden by default) -->
            <div id="bulkDeleteProgressSection" style="display:none;">
              <p style="margin-bottom:1rem;">Deleting attendance records...</p>
              <div style="background:#0a1510; border:1px solid #275b48; border-radius:8px; padding:1rem; margin-bottom:1rem;">
                <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                  <span>Progress:</span>
                  <span id="bulkDeleteProgressText">0 / 0</span>
                </div>
                <div style="background:#1a2e24; border-radius:4px; height:20px; overflow:hidden;">
                  <div id="bulkDeleteProgressBar" style="background:linear-gradient(90deg, #16a34a, #22c55e); height:100%; width:0%; transition:width 0.3s ease;"></div>
                </div>
              </div>
              <div id="bulkDeleteCurrentItem" style="color:#8ab4a0; font-size:0.9rem;">Preparing...</div>
            </div>
          </div>
          <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem;">
            <button class="actions-btn" id="bulkDeleteCancelBtn" onclick="window.cancelBulkDeleteAttendance?.()">Cancel</button>
            <button class="actions-btn delete-btn" id="confirmBulkDeleteAttendanceBtn" onclick="window.confirmBulkDeleteAttendance?.()">Delete All Selected</button>
          </div>
        </div>
      </div>

        <!-- Delete Success Modal -->
        <div id="deleteSuccessModal" class="modal">
          <div class="modal-content" role="dialog" aria-modal="true" style="max-width:400px;">
            <span class="close" onclick="window.closeDeleteSuccessModal?.()">&times;</span>
            <div class="modal-header">
              <h3 style="margin:0; color:#16a34a;">Attendance Deleted</h3>
            </div>
            <div class="modal-body">
              <p>The attendance record was deleted successfully.</p>
            </div>
            <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem;">
              <button class="actions-btn" onclick="window.closeDeleteSuccessModal?.()">OK</button>
            </div>
          </div>
        </div>

        <!-- Duplicate Attendance Warning Modal -->
    </div>

    <!-- Duplicate Attendance Warning Modal (moved outside main wrapper for visibility) -->
    <div id="duplicateAttendanceModal" class="modal">
      <div class="modal-content" role="dialog" aria-modal="true" style="max-width:400px; z-index:1000;">
        <span class="close" onclick="window.closeDuplicateAttendanceModal?.()">&times;</span>
        <div class="modal-header">
          <h3 style="margin:0; color:#d9534f;">Duplicate Attendance</h3>
        </div>
        <div class="modal-body">
          <p>An attendance record already exists for this employee and date.</p>
          <p class="muted" style="margin-top:.5rem;">Please edit or delete the existing record if you need to make changes.</p>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem;">
          <button class="actions-btn" onclick="window.closeDuplicateAttendanceModal?.()">OK</button>
        </div>
      </div>
    </div>

    <!-- Notification Modal -->
    <div id="attendanceNotificationModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:400px; text-align:center;">
        <div id="attendanceNotificationIcon" style="font-size:3rem; margin-bottom:1rem;">‚úÖ</div>
        <h3 id="attendanceNotificationTitle" style="margin:0 0 0.5rem; color:#fff;">Success</h3>
        <p id="attendanceNotificationMessage" style="margin:0 0 1.5rem; color:#ccc;">Operation completed successfully.</p>
        <button class="btn-primary" onclick="window.closeAttendanceNotificationModal?.()">OK</button>
      </div>
    </div>

    <!-- Diagnose Attendance Rates Modal -->
    <div id="diagnoseAttendanceModal" class="modal" style="display:none;">
      <div class="modal-content" role="dialog" aria-modal="true" style="max-width:900px;">
        <span class="close" onclick="window.closeDiagnoseAttendanceModal?.()">&times;</span>
        <div class="modal-header" style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding:1rem 1.5rem; border-radius:8px 8px 0 0;">
          <h3 style="margin:0; color:#fff;">üîç Diagnose & Recalculate Attendance Rates</h3>
          <p style="margin:0.25rem 0 0; color:rgba(255,255,255,0.85); font-size:0.9rem;">Check if attendance records match current employee salary settings</p>
        </div>
        <div class="modal-body" style="padding:1.5rem;">
          <div id="diagnoseEmployeeInfo" style="background:#0d1b0e; border:1px solid #275b48; border-radius:8px; padding:1rem; margin-bottom:1rem;">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem;">
              <div>
                <div style="color:#8ab8a8; font-size:0.75rem; text-transform:uppercase;">Employee</div>
                <div id="diagnoseEmpName" style="color:#fff; font-weight:600;">-</div>
              </div>
              <div>
                <div style="color:#8ab8a8; font-size:0.75rem; text-transform:uppercase;">Current Base Salary</div>
                <div id="diagnoseEmpSalary" style="color:#28a745; font-weight:600;">‚Ç±0.00</div>
              </div>
              <div>
                <div style="color:#8ab8a8; font-size:0.75rem; text-transform:uppercase;">Expected Hourly Rate</div>
                <div id="diagnoseExpectedRate" style="color:#0dcaf0; font-weight:600;">‚Ç±0.00/hr</div>
              </div>
            </div>
          </div>
          
          <div id="diagnoseLoading" style="text-align:center; padding:2rem; display:none;">
            <div style="width:40px; height:40px; border:4px solid #275b48; border-top-color:#f59e0b; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem;"></div>
            <div style="color:#ccc;">Analyzing attendance records...</div>
          </div>
          
          <div id="diagnoseResults" style="display:none;">
            <div id="diagnoseSummary" style="background:rgba(40,167,69,0.1); border:1px solid #28a745; border-radius:8px; padding:1rem; margin-bottom:1rem;">
              <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1rem; text-align:center;">
                <div>
                  <div style="color:#8ab8a8; font-size:0.75rem;">Total Records</div>
                  <div id="diagnoseTotalRecords" style="color:#fff; font-size:1.5rem; font-weight:600;">0</div>
                </div>
                <div>
                  <div style="color:#8ab8a8; font-size:0.75rem;">Correct</div>
                  <div id="diagnoseCorrectCount" style="color:#28a745; font-size:1.5rem; font-weight:600;">0</div>
                </div>
                <div>
                  <div style="color:#8ab8a8; font-size:0.75rem;">Need Update</div>
                  <div id="diagnoseNeedUpdateCount" style="color:#f59e0b; font-size:1.5rem; font-weight:600;">0</div>
                </div>
                <div>
                  <div style="color:#8ab8a8; font-size:0.75rem;">Status</div>
                  <div id="diagnoseStatus" style="font-size:1.2rem; font-weight:600;">-</div>
                </div>
              </div>
            </div>
            
            <div id="diagnoseIssuesContainer" style="max-height:300px; overflow-y:auto; border:1px solid #275b48; border-radius:8px;">
              <table style="width:100%; border-collapse:collapse;">
                <thead style="position:sticky; top:0; background:#0d1b0e;">
                  <tr>
                    <th style="padding:0.75rem; text-align:left; border-bottom:1px solid #275b48;">Date</th>
                    <th style="padding:0.75rem; text-align:right; border-bottom:1px solid #275b48;">Total Hours</th>
                    <th style="padding:0.75rem; text-align:right; border-bottom:1px solid #275b48;">Current OT</th>
                    <th style="padding:0.75rem; text-align:right; border-bottom:1px solid #275b48;">Expected OT</th>
                    <th style="padding:0.75rem; text-align:right; border-bottom:1px solid #275b48;">Current OT Pay</th>
                    <th style="padding:0.75rem; text-align:right; border-bottom:1px solid #275b48;">Expected OT Pay</th>
                    <th style="padding:0.75rem; text-align:center; border-bottom:1px solid #275b48;">Status</th>
                  </tr>
                </thead>
                <tbody id="diagnoseIssuesBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:0.5rem; padding:1rem 1.5rem; border-top:1px solid #275b48;">
          <button class="actions-btn" onclick="window.closeDiagnoseAttendanceModal?.()">Close</button>
          <button class="btn-primary" id="diagnoseRunBtn" onclick="window.runAttendanceDiagnosis?.()" style="background:linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);">
            üîç Run Diagnosis
          </button>
          <button class="btn-primary" id="diagnoseFixBtn" onclick="window.fixAttendanceRates?.()" style="background:linear-gradient(135deg, #28a745 0%, #198754 100%); display:none;">
            ‚úì Fix All Issues
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Centralized Airtable Config - must load before API scripts -->
  <script src="../airtable-config.js"></script>
  <script src="./employees-api.js"></script>
  <script src="./attendance-api.js"></script>
  <script src="./departments-api.js"></script>
  <script src="attendance.js"></script>
  
  <!-- Audit Log Scripts -->
  <script src="../audit-log/audit-log-api.js"></script>
  <script src="../audit-log/audit-log.js"></script>
  <script src="../audit-log/audit-log-modal.js"></script>
  <script>
    // Dynamically populate department filter from Airtable
    document.addEventListener('DOMContentLoaded', async function() {
      if (window.DepartmentsAPI?.populateDepartmentSelect) {
        const deptFilter = document.getElementById('attendanceDepartmentFilter');
        if (deptFilter) {
          await window.DepartmentsAPI.populateDepartmentSelect(deptFilter);
        }
      }
    });
  </script>
  
  <!-- HR Assistant - Help System -->
  <link rel="stylesheet" href="hr-assistant.css" />
  <script src="hr-assistant.js"></script>
  
  <!-- User Account Scripts -->
  <script src="../login/user-account.js"></script>
</body>
</html>